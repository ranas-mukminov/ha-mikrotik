name: Static Checks

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  static-checks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Check required files exist
      run: |
        echo "Checking for required files..."
        test -f README.md || { echo "ERROR: README.md not found"; exit 1; }
        test -f HA_init.rsc || { echo "ERROR: HA_init.rsc not found"; exit 1; }
        test -f VERSION || { echo "ERROR: VERSION not found"; exit 1; }
        test -f VERSION.checksum || { echo "ERROR: VERSION.checksum not found"; exit 1; }
        test -f generate || { echo "ERROR: generate script not found"; exit 1; }
        test -d scripts || { echo "ERROR: scripts/ directory not found"; exit 1; }
        echo "✓ All required files exist"
        
    - name: Check VERSION format
      run: |
        echo "Checking VERSION format..."
        VERSION=$(cat VERSION)
        if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+.*$ ]]; then
          echo "ERROR: VERSION doesn't match expected format (X.Y...)"
          exit 1
        fi
        echo "✓ VERSION format is valid: $VERSION"
        
    - name: Check for tabs in scripts
      run: |
        echo "Checking for tabs in scripts..."
        if grep -P '\t' scripts/*.script; then
          echo "ERROR: Found tabs in script files. Please use spaces for indentation."
          exit 1
        fi
        echo "✓ No tabs found in scripts"
        
    - name: Check for trailing whitespace
      run: |
        echo "Checking for excessive trailing whitespace..."
        # Allow single trailing space but catch multiple
        if grep -E ' {2,}$' scripts/*.script README.md; then
          echo "WARNING: Found lines with multiple trailing spaces"
          # Don't fail, just warn
        fi
        echo "✓ Trailing whitespace check complete"
        
    - name: Verify script files referenced in generate
      run: |
        echo "Checking that all scripts in scripts/ are used by generate..."
        for script in scripts/*.script; do
          basename_script=$(basename "$script")
          if ! grep -q "$basename_script" generate; then
            echo "WARNING: $basename_script not referenced in generate script"
          fi
        done
        echo "✓ Script reference check complete"
        
    - name: Check for hardcoded secrets
      run: |
        echo "Checking for hardcoded secrets/passwords..."
        # Look for suspicious patterns but exclude placeholder examples
        if grep -E 'password="[a-f0-9]{40}"' scripts/*.script HA_init.rsc | grep -v "E1:81:8C" | grep -v "%%%"; then
          echo "WARNING: Found potential hardcoded SHA1 password hashes"
        fi
        if grep -E 'password="[^[]' scripts/*.script | grep -v "%%%HA_PASSWORD%%%" | grep -v 'password=p' | grep -v 'password="p"'; then
          echo "WARNING: Found potential hardcoded passwords"
        fi
        echo "✓ Secret check complete (warnings may exist)"
        
    - name: Verify HA_init.rsc is up to date
      run: |
        echo "Checking if HA_init.rsc is up to date with scripts..."
        ./generate
        if git diff --exit-code HA_init.rsc; then
          echo "✓ HA_init.rsc is up to date"
        else
          echo "ERROR: HA_init.rsc is out of sync with scripts/"
          echo "Please run './generate' and commit the updated HA_init.rsc"
          exit 1
        fi
        
    - name: Check RouterOS function names are consistent
      run: |
        echo "Checking RouterOS function naming consistency..."
        # Verify key functions are defined in ha_functions.script
        test -f scripts/ha_functions.script || { echo "ERROR: ha_functions.script not found"; exit 1; }
        
        for func in HADebug HAPushStandby HASyncStandby HAInstall HASwitchRole; do
          if ! grep -q ":global $func do=" scripts/ha_functions.script; then
            echo "ERROR: Function $func not found in ha_functions.script"
            exit 1
          fi
        done
        echo "✓ All required HA functions are defined"
        
    - name: Summary
      if: always()
      run: |
        echo "=========================================="
        echo "Static checks completed"
        echo "=========================================="
        echo ""
        echo "Note: This CI only validates file structure and consistency."
        echo "It does NOT test actual RouterOS functionality."
        echo "Always test changes in a lab environment with real hardware."
